<!DOCTYPE html>
<html lang="en" debug="true">
<head>
    <meta charset="UTF-8">
    <title>LeafLet Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
          integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
          crossorigin=""/>
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <script src="libs/jquery.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
            integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
            crossorigin=""></script>
    <script src="libs/Leaflet.Editable.js"></script>
    <script src="scripts/toolBar.js"></script>
    <script src="scripts/handlers.js"></script>
    <script src="scripts/initJavaController.js"></script>
   <!-- <script type="text/javascript" src="https://getfirebug.com/firebug-lite.js"></script>-->


    <script>
        var map;
        var startPoint = [59.583921, 31.192010];
        var currentZoom = 13;
        var JAVA = {};

        let lastPoint = startPoint;

        var points = [];
        var lines = {};
        var selectedLine;
        function onMapLoad() {

            map = L.map('mapid',{"editable":true, "zoomControl":false}).setView(startPoint, 13);


            map.myclick.enable();

            //http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png
            //file:///C:/Users/User/IdeaProjects/testOpenLayer/tiles/opentopomap.org/{z}/{x}/{y}.png
            L.tileLayer('http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            /*var polyline = L.polyline([[43.1, 1.2], [43.2, 1.3],[43.3, 1.2]]).addTo(map);
            polyline.enableEdit();*/



            map.on("editable:vertex:deleted", handlers.deleteVertex);

            map.on("editable:vertex:new", handlers.creteNewVertex);

            map.on("editable:drawing:end", handlers.stopCreatingLine);

            map.on("editable:vertex:click", handlers.clickPoint);

            map.on("editable:drawing:click", handlers.clickLine);

            map.on('mousemove', handlers.mouseMove);

            map.on('zoomend', handlers.setZoom)


            ////////////add delete shape
/*
            var deleteShape = function (e) {
                console.log(this);
                console.log(e.latlng)
                if ((e.originalEvent.ctrlKey || e.originalEvent.metaKey) && this.editEnabled()) this.editor.deleteShapeAt(e.latlng);
            };
            map.on('layeradd', function (e) {
                if (e.layer instanceof L.Path) e.layer.on('click', L.DomEvent.stop).on('click', deleteShape, e.layer);
                if (e.layer instanceof L.Path) e.layer.on('dblclick', L.DomEvent.stop).on('dblclick', e.layer.toggleEdit);
                console.log("add layer")
            });*/



            //map.addHandler('click', L.MyHandler);


        }

        $(function () {

            onMapLoad();

            addToolBar(map);

            JAVA = initJava();

        });


        var getFromJava = function(msg){
            var parsed = JSON.parse(msg);
            JAVA.log("ID: "+parsed.id+" NAME: "+parsed.name)
        };

        function resizeMap(width, height) {
            $('#mapid').css({'width':width, 'height':height})
        }

        function selectLine(id) {
            if (selectedLine != undefined) unSelectLine();
            var line = lines[id];
            selectedLine = line;
            line.setStyle({"color":"red"});
        }

        function unSelectLine() {
            selectedLine.setStyle({"color":"blue"})
        }

        function getTilesImg() {
            var imgs = "";
            $('.leaflet-tile-container').find("img").each(function (i) {
                console.log($(this).attr('src'))
                imgs += $(this).attr('src')+",";
            });
            JAVA.returnTilesImg(imgs);
        }

        function startTrack() {
            map.editTools.startPolyline();
            JAVA.setStatus("Start polyline")
        }
        function startRegion() {
            map.editTools.startRectangle();
            JAVA.setStatus("Start region")
        }
        function addMarker() {
            map.editTools.startMarker();
            JAVA.setStatus("Add marker")
        }
        function zoomPlus() {
            map.setZoom(map.getZoom()+1);
            JAVA.setStatus("Map zoomed up");
        }
        function zoomMinus() {
            map.setZoom(map.getZoom()-1);
            JAVA.setStatus("Map zoomed down");
        }
        function getZoom() {
            return map.getZoom();
        }



    </script>
    <style>
        #mapid {
            width: 750px;
            height: 750px;
        }
    </style>

</head>
<body>
<div id="mapid"></div>
</body>
</html>