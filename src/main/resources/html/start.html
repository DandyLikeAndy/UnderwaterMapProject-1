<!DOCTYPE html>
<html lang="en" debug="true">
<head>
    <meta charset="UTF-8">
    <title>LeafLet Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
          integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
          crossorigin=""/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <script src="libs/jquery.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
            integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
            crossorigin=""></script>
    <script src="libs/Leaflet.Editable.js"></script>
    <script src="scripts/toolBar.js"></script>
    <script src="scripts/handlers.js"></script>
    <script src="scripts/initJavaController.js"></script>
    <script src="scripts/models.js"></script>

    <script>
        var map;
        var startPoint = [59.583921, 31.192010];
        var currentZoom = 13;
        var JAVA = {};
        var currentRadius = 15;

        var tools;

        var lastPoint = startPoint;

        var tempLine = null;

        var points = [];
        var lines = new Map();
        var selectedLine;
        let mapLayer;
        function onMapLoad() {


            map = L.map('mapid', {"editable": true, "zoomControl": false}).setView(startPoint, 13);


            map.myclick.enable();

            //http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png
            //file:///C:/Users/User/IdeaProjects/testOpenLayer/tiles/opentopomap.org/{z}/{x}/{y}.png
           /* L.tileLayer('http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);*/
            mapLayer = L.tileLayer('http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: ''
            });
            mapLayer.addTo(map);

            /*var polyline = L.polyline([[43.1, 1.2], [43.2, 1.3],[43.3, 1.2]]).addTo(map);
            polyline.enableEdit();*/


            map.on("editable:vertex:deleted", handlers.deleteVertex);

            map.on("editable:vertex:new", handlers.creteNewVertex);

            map.on("editable:drawing:end", handlers.stopCreatingLine);

            map.on("editable:vertex:click", handlers.clickPoint);

            map.on("editable:drawing:click", handlers.clickLine);

            map.on('mousemove', handlers.mouseMove);

            map.on('zoomend', handlers.setZoom);

            map.on("editable:vertex:drag", handlers.dragVertex);

            map.on("editable:vertex:dragend ", handlers.dragEndVertex);

            //map.on("editable:created", handlers.createNewLayer);

            map.on("layeradd", handlers.createNewLayer)

            ////////////add delete shape
            /*
                        var deleteShape = function (e) {
                            console.log(this);
                            console.log(e.latlng)
                            if ((e.originalEvent.ctrlKey || e.originalEvent.metaKey) && this.editEnabled()) this.editor.deleteShapeAt(e.latlng);
                        };
                        map.on('layeradd', function (e) {
                            if (e.layer instanceof L.Path) e.layer.on('click', L.DomEvent.stop).on('click', deleteShape, e.layer);
                            if (e.layer instanceof L.Path) e.layer.on('dblclick', L.DomEvent.stop).on('dblclick', e.layer.toggleEdit);
                            console.log("add layer")
                        });*/


            //map.addHandler('click', L.MyHandler);


        }



        $(function () {

            onMapLoad();

            tools = addToolBar(map);

            JAVA = initJava();

        });


        var getFromJava = function (msg) {
            var parsed = JSON.parse(msg);
            JAVA.log("ID: " + parsed.id + " NAME: " + parsed.name)
        };

        function resizeMap(width, height) {
            $('#mapid').css({'width': width, 'height': height})
        }

        function selectLine(id) {
            if (selectedLine != undefined) unSelectLine();
            var line = lines[id];
            selectedLine = line;
            line.setStyle({"color": "red"});
        }

        function unSelectLine() {
            selectedLine.setStyle({"color": "blue"})
        }

        function getTilesImg() {
            let imgs = "";
            $('.leaflet-tile-container').find("img").each(function (i) {
                console.log($(this).attr('src'))
                imgs += $(this).attr('src') + ",";
            });
            JAVA.returnTilesImg(imgs);
        }

        function startTrack() {
            map.editTools.startPolyline();
            JAVA.setStatus("Start polyline")
        }
        function startRegion() {
            map.editTools.startRectangle();
            JAVA.setStatus("Start region")
        }
        function addMarker() {
            map.editTools.startMarker();
            JAVA.setStatus("Add marker")
        }
        function zoomPlus() {
            map.setZoom(map.getZoom() + 1);
            JAVA.setStatus("Map zoomed up");
        }
        function zoomMinus() {
            map.setZoom(map.getZoom() - 1);
            JAVA.setStatus("Map zoomed down");
        }
        function getZoom() {
            return map.getZoom();
        }

        function setPointsRadius(radius){
            for (i in lines){
                const line = lines[i];
                for (p in line._latlngs){
                    line._latlngs[p].__vertex.circle.setRadius(200)
                }
            }
        }

        function setPointRadius(pointId, radius) {
            //console.log(lines);
            for (i in lines){
                const line = lines[i];
                const latlngs = line.getLatLngs();
                for (p in latlngs){
                    if (latlngs[p].__vertex._leaflet_id == pointId){
                        latlngs[p].__vertex.circle.setRadius(radius);
                    }
                }
            }
        }


        function initJavaController() {
            JAVA = initJava();
            removeToolBars();
        }

        function deletePoint(pointId, lineId) {
            //TODO: может перенести удаление точки в объект line?
            let line = lines.get(lineId);
            let point = line.points.get(pointId);
            point.vertex.delete();
            line.deletePoint(pointId);
        }

        function deleteLine(lineId) {
            //TODO: может перенести удаление линии в контейнер lines и сделать lines объектом, хранящим map
            let line = lines.get(lineId);
            line.layer.remove();
            lines.delete(lineId);
            JAVA.deleteLine(lineId);
        }

        function removeToolBars() {
            for (let t in tools){
                map.removeControl(tools[t]);
            }
        }

        function setMapUrl(url, subdomains) {

            mapLayer.remove();
            if (subdomains != ""){
                JAVA.log("url "+url+" "+subdomains.split(","));
                mapLayer = L.tileLayer(url, {
                    attribution: '',
                    subdomains:subdomains.split(",")
                });
            } else {
                mapLayer = L.tileLayer(url, {
                    attribution: ''
                });
            }

            //mapLayer.setUrl(url);
            //mapLayer.setOptions = {"subdomains":subdomains};

            mapLayer.addTo(map);
            //JAVA.log(url);
        }

        function setPosition() {
            $.getJSON('https://ipinfo.io', function(data){
                JAVA.log(data.loc);
                let point = data.loc.split(",");
                map.setView(point);
                L.marker(point).addTo(map);
            });
        }

        function addActiveLine(coords) {
            let newLine = L.polyline(JSON.parse(coords)).addTo(map);
            newLine.enableEdit(map);
            //console.log(newLine);

            let newTrack = new Track();
            newTrack.id = newLine._leaflet_id;
            let latlngs = newLine._latlngs;
            for (let i=0; i<latlngs.length; i++){
                //console.log("i "+i);
                let latlng = latlngs[i];

                let point = new Point();
                let circle = new L.circle(latlng, {radius:currentRadius}).addTo(map);
                console.log(latlng);
                latlng.__vertex.circle = circle;
                latlng.__vertex.point = point;
                let index = latlngs.indexOf(latlng);

                if (index != latlngs.length-1){
                    handlers.updatePositions(newTrack);
                    JAVA.updateTrack(newTrack);
                }
                if (index == 0){
                    latlng.__vertex.setIcon(new L.StartIcon({'number': index}));
                } else{
                    latlng.__vertex.setIcon(new L.MyIcon({'number': index}));
                }

                point.vertex = latlng.__vertex;
                point.circle = circle;
                point.id = latlng.__vertex._leaflet_id;
                point.lat = latlng.lat;
                point.lng = latlng.lng;
                point.pos = index;
                point.circleRadius = currentRadius;
                point.line = newTrack;


                latlng.__vertex.point = point;
                newTrack.addPoint(point);
                newLine.setStyle({"weight":10});
                console.log("create");
                //lines.set(lineId, e.layer);



            }
            lines.set(newTrack.id, newTrack);
            newTrack.layer = newLine;

            handlers.updateDistance(newTrack);
            //JAVA.addLine(JSON.stringify(newTrack));
            latlngs[ latlngs.length-1].__vertex.setIcon(new L.FinishIcon({'number':latlngs.length-1}));
            return JSON.stringify(newTrack);

        }

        function addMarker(lat, lon, name) {
            JAVA.log("Call method ADD marker from JAVA")
            let marker = L.marker([lat, lon]);
            marker.isCustom = true;
            marker.name = name;
            marker.addTo(map);

        }

        function startMarker() {
            JAVA.log("Call method Start marker from JAVA")
            let marker = map.editTools.startMarker();
            marker.name = "Click marker";
            marker.isCustom = true;
        }

        function addGeoJson(geoJson) {
            JAVA.log("add geoJson");
            let geoJsonObj = JSON.parse(geoJson);

            JAVA.log(geoJsonObj.type);

            L.geoJson(geoJsonObj).addTo(map);
        }






    </script>
    <style>
        #mapid {
            width: 750px;
            height: 750px;
        }

        #FirebugLite {
            width: 300px;
            height: 300px;
        }
    </style>

</head>
<body>
<div id="mapid"></div>
</body>
</html>